libname RAW "D:\raw";
libname MYLIB "D:\mylib";
libname AYA "D:\aya02";



/*data preparation*/
proc sql noprint;
create table Comorbidity as select distinct * from AYA.disease where studyid in (select studyid from aya.final);
quit;

proc sql noprint;
create table drug_histody as select distinct * from  aya.drug_after_cancer01 where studyid in (select studyid from aya.final);
quit;


data entrydate;
set aya.final;
keep studyid entrydate;
run;

data aya.comorbidity;
merge comorbidity entrydate;
by studyid;
run;

data aya.drug_histody;
merge drug_histody entrydate;
by studyid;
run;




/*diagnosis - icd*/
data hypertension_icd;
set aya.comorbidity;
if icd in: ('I10', 'I11', 'I12', 'I13', 'I14', 'I15');
run;

data diabete_icd;
set aya.comorbidity;
if icd in: ('E10', 'E11', 'E12', 'E13', 'E14', 'E15');
run;

data hyperlip_icd;
set aya.comorbidity;
if icd in: ('E78');
run;

data CAD_icd;
set aya.comorbidity;
if icd in: ('I20', 'I21', 'I22', 'I23', 'I24', 'I25');
run;

data AF_icd;
set aya.comorbidity;
if icd = "I48" AND dis_code not in: ('8847818', '8847814', '8846942', '8846694', '8850690', '4273014', '8847735', '4273009') ;
run;

data hypothy_icd;
set aya.comorbidity;
if icd = 'E03';
run;



/*prescription - atc*/
data baseline;
set aya.drug_histody;
if rx_start_date = . then delete;
run;

data hypertension_atc;
set baseline;
if atc in: ('C02', 'C03', 'C04', 'C07', 'C08', 'C09');
run;

data diabete_atc;
set baseline;
if atc in: ('A10');
run;

data hyperlip_atc;
set baseline;
if atc in: ('C10');
run;

data hypothy_atc;
set baseline;
if atc in: ('H03A');
run;

/*procedure - shinryo code*/

data pro_code;
set raw.procedure_master;
keep var1 var8;
rename var1 = proc_code var8 = kubun_code;
run;

proc sort data = pro_code nodupkey;
by proc_code;
run;


proc sql noprint;
create table proc_history as select distinct * from  mylib.Aya_procedure where studyid in (select studyid from aya.final);
quit;

proc sort data = proc_history;
by proc_code;
run;

data aya.proc_history;
  merge proc_history(in=a) pro_code(in=b);
  if a and b;
  by proc_code;
run;

data cad_proc;
set aya.proc_history;
if kubun_code in: ('K546', 'K547', 'K548', 'K549', 'K550', 'K552', 'K553');
run;
/*obs 0*/



/*condition1 - 2 visits, 30d apart*/
%macro condition1 (data=);

data &data._01;
set &data.;
lookback = entrydate-dis_start_date;
if 0<=lookback<=180;
run;

proc sort data = &data._01;
by studyid dis_start_date;
run;

data history;
set &data._01;
dis_start_date_1=lag(dis_start_date);
if _n_=1 then dis_start_date_1=0;
interval=dis_start_date-dis_start_date_1;
run;

data history01;
set history;
if interval>=30 then history = 1;
else history = 0;
run;

proc sort data = history01;
by studyid history;
run;

data history02;
set history01;
by studyid;
if last.studyid;
run;

data aya.&data._condition01;
set history02;
if history = 1;
run;

%mend condition1;


%condition1 (data=hypertension_icd);
/*obs 39*/
%condition1 (data=diabete_icd);
/*obs 57*/
%condition1 (data=hyperlip_icd);
/*obs 38*/
%condition1 (data=CAD_icd);
/*obs 8*/
%condition1 (data=AF_icd);
/*obs 1*/
%condition1 (data=hypothy_icd);
/*obs 18*/


/*condition2 - at least 1 diagnosis, 1 prescription/procedure*/
/*condition2_atc*/
%macro condition_atc (data=);
data &data._01;
set &data.;
lookback_atc = entrydate-rx_start_date;
if 0<=lookback_atc<=180;
run;

proc sort data = &data._01 nodupkey;
by studyid;
run;
%mend condition_atc ;

%condition_atc (data=hypertension_atc);
/*obs 173*/
%condition_atc (data=diabete_atc);
/*obs 32*/
%condition_atc (data=hyperlip_atc);
/*obs 13*/
%condition_atc (data=hypothy_atc);
/*obs 15*/


data aya.hypertension_condition02;
  merge hypertension_atc_01(in=a) hypertension_icd_01(in=b);
  if a and b;
  by studyid;
run;

data aya.diabete_condition02;
  merge diabete_atc_01(in=a) diabete_icd_01(in=b);
  if a and b;
  by studyid;
run;


data aya.hyperlip_condition02;
  merge hyperlip_atc_01(in=a) hyperlip_icd_01(in=b);
  if a and b;
  by studyid;
run;


data aya.hypothy_condition02;
  merge hypothy_atc_01(in=a) hypothy_icd_01(in=b);
  if a and b;
  by studyid;
run;


data aya.AF_condition02;
set AF_icd_01;
run;

data aya.cad_condition02;
set cad_icd_01;
run;

%macro condition02_count (data = );
proc sort data = aya.&data._condition02 nodupkey;
by studyid;
run;
%mend;

%condition02_count(data = hypertension)
/*obs 40*/
%condition02_count(data = diabete)
/*obs 20*/
%condition02_count(data = hyperlip)
/*obs 11*/
%condition02_count(data = hypothy)
/*obs 13*/
%condition02_count(data = AF)
/*obs 3*/
%condition02_count(data = cad)
/*obs 15*/


/*combining condition 1 and 2*/
data hypertension;
  merge aya.hypertension_icd_condition01(in=a) aya.hypertension_condition02(in=b);
  if a or b;
  by studyid;
  hypertension= 1;
run;
/*obs 48*/

data diabete;
  merge aya.diabete_icd_condition01(in=a) aya.diabete_condition02(in=b);
  if a or b;
  by studyid;
  diabete= 1;
run;
/*obs 60*/

data hyperlip;
  merge aya.hyperlip_icd_condition01(in=a) aya.hyperlip_condition02(in=b);
  if a or b;
  by studyid;
  hyperlip= 1;
run;
/*obs 41*/

data hypothy;
  merge aya.hypothy_icd_condition01(in=a) aya.hypothy_condition02(in=b);
  if a or b;
  by studyid;
  hypothy= 1;
run;
/*obs 20*/

data AF;
  merge aya.AF_icd_condition01(in=a) aya.AF_condition02(in=b);
  if a or b;
  by studyid;
  AF= 1;
run;
/*obs 3*/

data cad;
  merge aya.CAD_icd_condition01(in=a) aya.cad_condition02(in=b);
  if a or b;
  by studyid;
  cad= 1;
run;
/*obs 15*/





%macro comorbidity (data = );
data &data._cormorbidity;
set &data;
keep studyid &data.;
run;
%mend comorbidity;
%comorbidity(data = hypertension);

%comorbidity(data = diabete);

%comorbidity(data = hyperlip);

%comorbidity(data = hypothy);

%comorbidity(data = AF);

%comorbidity(data = cad);



data patientlist;
set aya.final;
keep studyid;
run;

data aya.baseline_comorbidity;
merge patientlist hypertension_cormorbidity diabete_cormorbidity hyperlip_cormorbidity hypothy_cormorbidity AF_cormorbidity cad_cormorbidity;
by studyid;
run;



libname RAW "D:\raw";
libname MYLIB "D:\mylib";
libname AYA "D:\aya02";

/*data preparation*/
proc sql noprint;
create table drug_histody as select distinct * from  aya.drug_after_cancer01 where studyid in (select studyid from aya.final);
quit;

data entrydate;
set aya.final;
keep studyid entrydate;
run;

data aya.drug_histody;
merge drug_histody entrydate;
by studyid;
run;

data treatment;
set aya.drug_histody;
if rx_start_date = . then delete;
run;

data treatment01;
set treatment;
where ATC like "L01DB%";
run;

proc sort data = treatment01;
by studyid rx_end_date;
run;

data treatment02;
set treatment01;
by studyid;
if last.studyid;
run;

data last_treat;
set treatment02;
keep studyid rx_end_date;
rename rx_end_date = last_treat;
run;

data treatment03;
merge treatment last_treat;
by studyid;
run;


data HER2_atc;
set treatment03;
if atc in: ('L01XC03', 'L01XC13', 'L01XC14');
run;

data VEGFR_atc;
set treatment03;
if atc in: ('L01XC07', 'L01XC21', 'L01XX44', 'S01LA05');
run;

data BRAF_atc;
set treatment03;
if atc in: ('L01EC01', 'L01EC02', 'L01EC03');
run;

data immune_atc;
set treatment03;
if atc in: ('L01XC17', 'L01XC18', 'L01XC11', 'L01XC28', '(L01XC32', 'L01XC31');
run;



%macro baseline_pre (data = );

data &data._01;
set &data.;
if entrydate<=rx_start_date <= last_treat;
run;

proc sort data = &data._01 nodupkey;
by studyid;
run;
%mend baseline_pre ;

%baseline_pre(data = HER2_atc);
/*obs 2*/
%baseline_pre(data = VEGFR_atc);
/*obs 5*/
%baseline_pre(data = BRAF_atc);
/*obs 0*/
%baseline_pre(data = immune_atc);
/*obs 0*/


/*facilities*/
proc sql noprint;
create table rece_info as select distinct * from raw.aya_rece where var1 in (select studyid from aya.final);
quit;


data facility;
set raw.facility;
keep var1 var6 var9;
rename var1 = facility_code var6 = facility_type var9 = cancer;
run;

data rece_info01;
set rece_info;
rename var5 = facility_code;
run;

proc sort data = rece_info01;
by facility_code;
run;

proc sort data = facility nodupkey;
by facility_code;
run;

data aya.facility;
  merge rece_info01(in=a) facility(in=b);
  if a and b;
  by facility_code;
run;

/*receptid on cohort entry day*/
proc sql noprint;
create table rece_entry as select distinct * from aya.ayapatient_anthra01 where studyid in (select studyid from aya.final);
quit;

proc sql noprint;
create table aya.facility_entry as select distinct * from aya.facility where var2 in (select receid from work.rece_entry);
quit;

proc freq data= aya.facility_entry order=freq;
tables facility_type/nocum nocol nopercent;
run;
/*
facility_type 度数 
その他病院 446 
大学病院 361 
国公立病院 323 
診療所 47 
*/

proc freq data= aya.facility_entry order=freq;
tables cancer/nocum nocol nopercent;
run;
/*
cancer 度数 
1 1094 
欠損値の度数 = 83 
*/

libname RAW "D:\raw";
libname MYLIB "D:\mylib";
libname AYA "D:\aya02";



/*identify cancer onset*/
data dis_code;
set Raw.Disease_master;
keep VAR1 VAR7 VAR8;
rename VAR1 = dis_code VAR7 = icd VAR8 = dis_name;
run;

proc sort data = dis_code;
by dis_code;
run;

proc sort data = MYLIB.AYA_disease;
by dis_code;
run;


data AYA.disease;
  merge MYLIB.AYA_disease(in=a) dis_code(in=b);
  if a and b;
  by dis_code;
run;

data AYA.cancer;
set AYA.disease;
where icd like "C%";
run;
/*1077962*/

data cancer_05_22;
set AYA.cancer;
if "01Jan2005"d<=dis_start_date<="31Dec2022"d;
run;
/*cancer diagnosis between 2005-present*/

proc sort data = cancer_05_22;
by studyid dis_start_date;
run;

data cancer_05_22_01;
set cancer_05_22;
by studyid;
if first.studyid;
run;

data aya.cancer_05_22;
set cancer_05_22_01;
rename dis_start_date = onset;
run;

/*patients who had cnacer diagnosis during 02-persent*/
/*obs 19785*/



/*inclusion criteria01: age 15-39*/
proc sql noprint;
create table aya.patientinfo as select distinct * from mylib.aya_demographics where studyid in (select studyid from AYA.cancer_05_22);
quit;


proc sort data = AYA.patientinfo;
by studyid;
run;


data birth;
merge AYA.cancer_05_22 AYA.patientinfo;
by studyid;
run;


data patientage;
set birth;
age = Int (yrdif (birthdt, onset, 'act/act'));
run;

data AYA.ayapatients;
set patientage;
if 15<=age<=39;
run;
/*cancer patients between 15-39*/
/*obs 2519*/


/*identify cohort entry*/
proc sql noprint;
create table aya.druginfo as select distinct * from mylib.aya_drug where studyid in (select studyid from AYA.ayapatients);
quit;


data onset;
set AYA.ayapatients;
keep studyid onset;
run;

proc sort data = onset;
by studyid;
run;

proc sort data = aya.druginfo;
by studyid;
run;

data drug_after_cancer;
merge aya.druginfo onset;
by studyid;
run;

data drug_code;
set raw.drug_master;
keep var1 var12;
run;

data drug_code01;
set drug_code;
rename var1 = drug_code var12 = ATC;
run;

proc sort data = drug_after_cancer;
by drug_code;
run;

proc sort data = drug_code01;
by drug_code;
run;


data aya.drug_after_cancer01;
  merge drug_after_cancer(in=a) drug_code01(in=b);
  if a and b;
  by drug_code;
run;


data drug_after_cancer02;
set drug_after_cancer01;
where ATC like "L01DB%";
run;

data drug_after_cancer03;
set drug_after_cancer02;
if rx_start_date =. then delete;
run; 

data  drug_after_cancer04;
set drug_after_cancer03;
days = rx_start_date - onset;
run;

proc sort data = drug_after_cancer04;
by studyid days;
run;


data  drug_after_cancer05;
set  drug_after_cancer04;
by studyid;
if first.studyid;
run;

data aya.ayapatient_anthra;
set drug_after_cancer05;
if days<0 then delete;
run;

data aya.ayapatient_anthra01;
set aya.ayapatient_anthra;
rename rx_start_date = entrydate;
run;
/*aya patients who had anthracycline prescription after cancer disgnosis*/
/*obs 2379*/


/*180d look-back*/
/*using recept data to identify earliest record*/
proc sql noprint;
create table rece_info as select distinct * from raw.aya_rece where var1 in (select studyid from aya.ayapatient_anthra01);
quit;

data rece_info;
  set rece_info;
  rename VAR1=STUDYID VAR2=RECEID;
  Y0=substr(VAR4, 1, 4);
  M0=substr(VAR4, 5, 2);
  format rece_date yymmdd10.;
  rece_date=mdy(M0, 1, Y0);
run;


proc sort data = rece_info;
by studyid rece_date;
run;

data rece_info01;
set rece_info;
by studyid;
if first.studyid;
run;


data rece_info02;
set rece_info01;
keep studyid rece_date;
run;

data look_back;
merge aya.ayapatient_anthra01 rece_info02;
by studyid;
run;

data aya.patients_lookback;
set look_back;
lookback = entrydate-rece_date;
if lookback >= 180;
run;
/*patients who have 180days of baseline observation*/
/*obs 1795*/



/*365 follow-up*/
proc sql noprint;
create table obsend as select distinct * from mylib.aya_demographics where studyid in (select studyid from aya.patients_lookback);
quit;

data obsend01;
set obsend;
keep studyid obs_end_date;
run;

data patient_followup;
merge aya.patients_lookback obsend01;
by studyid;
run;


data aya.patient_followup;
set patient_followup;
followup = obs_end_date - entrydate;
if followup>=365;
run;
/*patients who have over 365 follow-up*/
/*obs 1255*/



proc sql noprint;
create table disease_history as select distinct * from mylib.aya_disease where studyid in (select studyid from aya.patient_followup);
quit;


data disease_code;
set raw.disease_master;
keep var1 var7;
run;

data disease_code01;
set disease_code;
rename var1 = dis_code var7 = icd;
run;


proc sort data = disease_code01;
by dis_code;
run;

proc sort data = disease_history;
by dis_code;
run;


data no_mi;
  merge disease_history(in=a) disease_code01(in=b);
  if a and b;
  by dis_code;
run;



data no_mi01;
set no_mi;
if icd in: ("I11", "I13", "I50") then MI_history = 1; 
else MI_history = 0;
run;

data entrydate;
set aya.patient_followup;
keep studyid entrydate;
run;

proc sort data = entrydate;
by studyid;
run;

proc sort data = no_mi01;
by studyid;
run;

data no_mi02;
merge no_mi01 entrydate;
by studyid;
run;

data no_mi03;
set no_mi02;
lookback = entrydate-dis_start_date;
if 0<=lookback <=180;
run;


proc sort data = no_mi03 nodupkey;
by studyid MI_history;
run;

data no_mi04;
set no_mi03;
if last.studyid;
by studyid;
run;

data aya.final;
set no_mi04;
if MI_history = 0;
run;
/*final patient list*/
/*obs 1177*/



/*initiated anthracycline*/
proc sql noprint;
create table anthracycline as select distinct * from aya.patient_followup where studyid in (select studyid from aya.final);
quit;

proc freq data= anthracycline order=freq;
tables ATC/nocum nocol nopercent;
run;

/*
L01DB01 517  ドキソルビシン
L01DB03 437  エピルビシン
L01DB06 78   イダルビシン
L01DB02 73   ダウノルビシン
L01DB08 53   ピラルビシン
L01DB07 13   ミトキサントロン
L01DB10 4    アムルビシン
L01DB04 2    アクラルビシン
*/



proc sql noprint;
create table onset_cancer as select distinct * from aya.cancer_05_22 where studyid in (select studyid from aya.final);
quit;

proc freq data= onset_cancer order=freq;
tables icd/nocum nocol nopercent;
run;

/*
C50	乳腺	565
C85	非ホジキンリンパ腫	137
C92	 骨髄性白血病	97
C91	 リンパ性白血病	54
C81	 ホジキン＜Hodgkin＞リンパ腫	35
C67	 膀胱	33
C49	その他の結合組織及び軟部組織	32
C95	 細胞型不明の白血病	29
C41	その他及び部位不明の骨及び関節軟骨	20
C40	肢の骨及び関節軟骨	19
C78	呼吸器及び消化器の続発性悪性新生物	15
C83	 非ろ＜濾＞胞性リンパ腫	15
C38	心臓，縦隔及び胸膜	12
C56	 卵巣	10
C34	 気管支及び肺	9
C54	 子宮体部	9
C22	 肝及び肝内胆管	8
C48	後腹膜及び腹膜	7
C79	その他の部位及び部位不明の続発性悪性新生物	7
C77	リンパ節の続発性及び部位不明の悪性新生物	6
C53	子宮頚部	5
C73	甲状腺	5
C16	 胃	4
C37	 胸腺	4
C08	 その他及び部位不明の大唾液腺	3
C62	 精巣＜睾丸＞	3
C84	 成熟T/NK細胞リンパ腫	3
C20	 直腸	2
C47	 末梢神経及び自律神経系	2
C66	 尿管	2
C71	 脳	2
C74	 副腎	2
C76	その他及び部位不明確の悪性新生物	2
C80	 悪性新生物, 部位が明示されていないもの 	2
C15	 食道	1
C17	 小腸	1
C18	 結腸	1
C25	 膵	1
C30	 鼻腔及び中耳	1
C31	 副鼻腔	1
C44	 皮膚のその他	1
C55	 子宮	1
C61	前立腺	1
C69	 眼及び付属器	1
C72	脊髄，脳神経及びその他の中枢神経系の部位	1
C75	 その他の内分泌腺及び関連組織	1
C82	 ろ＜濾＞胞性リンパ腫	1
C86	 T/NK細胞リンパ腫のその他	1
C88	 悪性免疫増殖性疾患	1
C90	多発性骨髄腫及び悪性形質細胞性新生物	1
C93	 単球性白血病	1

*/

/*estimation of over-aged patients*/
proc sql noprint;
create table birthday as select distinct * from aya.patientinfo where studyid in (select studyid from aya.final);
quit;

data birthday01;
set birthday;
keep studyid birthdt;
run;

data entryage;
merge anthracycline birthday01;
by studyid;
run;

data entryage01;
set entryage;
entryage = Int (yrdif (birthdt, entrydate, 'act/act'));
run;


proc freq data= entryage01 order=freq;
tables entryage/nocum nocol nopercent;
run;

data overage;
set entryage01;
if entryage > 39;
run;
/*72 were older than 39 when anthracyccline prescribed*/

